
# /* Copyright (C) 2010, Cybernetica AS, http://www.cybernetica.eu/ */

Paikade tegemine

Ettevalmistused paikade tegemiseks (seda teeb CERT)

Enne esimese paiga välja andmist ja ühegi tuvastaja sertifitseerimist tuleb 
luua võtmepaar paikade signeerimiseks. Seda tuleb teha administraatori arvutis, 
mis on turvaline, ja kindlasti mitte keskuse arvutis.

Paikamise keskkond s4a-patch.tgz tuleb mingis kataloogis lahti pakkida, tekib 
alamkataloog s4a-patch. Seal kataloogis olles tuleb käivitada
./genpatchkey.sh
Võtmele küsitakse ka parooli, seda on edaspidi paikade signeerimisel vaja.

Selle tulemusena tekivad kaks faili: s4apatch.pem on sertifikaat ja
s4apatch.key on salajane võti signeerimiseks. s4apatch.pem tuleb toimetada
keskusse ja panna seal kataloogi /var/www/ca/cafiles/gentemp sama nime all
(s4apatch.pem) enne esimese tuvastaja sertifitseerimist. Nii läheb tuvastajale
koos sertifikaatidega kaasa ka paikade verifitseerimise võti. Alternatiivina
võib võtme kopeerida otse mõnda tuvastajasse failiks
/var/www/tuvastaja/data/cacerts/s4apatch.pem või saata see hooldajale, kes
selle ISO imagesse selle nime all kaasa paneks.

Käivita paikamise kataloogis "make", see kompileerib ära paiga signeerimise
programmi patch_sign. Eelduseks on C arendusvahendite ja OpenSSL teegi ning
päiste olemasolu arvutis. patch_sign on testitud nii OpenBSDs kui Linuxis,
mujal või uuemates versioonides tööle saamine peaks olema samuti lihtne.

Paiga kokku panemine

(seda teeb süsteemi hooldaja ja edastab signeerimata paigad CERT-ile)

Tee s4a-patch kataloogi alla uue paiga jaoks uus alamkataloog, nimeks 
soovitavalt paiga number (näiteks 4.6.1) ja kopeeri tarnijalt või tekita ise 
sinna alamkataloogi paiga jaoks vajalikud failid:

spatch.level - paiga versioon, näiteks 4.6.1
spatch.rootspace - mitu kilobaiti vaba ruumi paik juurkataloogis nõuab
spatch.lst - nimekiri bsd-pakkidest, mis paiga sisse panna.
         See nimekiri sisaldab bsd täispakinimesid kujul pakinimi-a.b.c-xy.tgz
packages/ - kataloog, mille alla tuleb panna paiga sisse minevad BSD-pakid
ning mille alt pannakse spatch.lst alusel kokku spatch.tar.

Täida failid või tee lisaks käsitsi valmis spatch.tar (kui seda on vaja teha
rooduna). Paki paiga kataloog kokku, nii et sisu jääb alamkataloogina (näiteks
4.6.1.tar.gz sisaldab kataloogi 4.6.1 spatch.* failidega). Anna fail CERT-ile
signeerimiseks.

Paiga signeerimine (seda teeb CERT)

Hooldaja saadab tarballi paiga sisuga, näiteks 4.6.1.tar.gz. Paki see lahti
paikamise kataloogi. Sisene tekkivasse alamkataloogi (4.6.1) ja kontrolli sisu üle. 
Signeerimiseks kasuta paiga alamkataloogis (4.6.1) olles käsku:
../s4apatch.sh
(vajalik on ka paikade signeerimise võtme parool)
See tekitab signeeritud paigafaili kujul patch-4.6.1.tgz. See paigafail tuleb
toimetada keskserverisse /var/www/confserv/patches kataloogi ning uuendada seal
kataloogis current-X.Y faili, nii et faili sisuks oleks paiga versiooni
patchlevel (näiteks 4.6.1 puhul tuleb faili current-4.6 kirjutada sisuks 1).

Paikamisvõtme vahetamine (seda teeb CERT)

Paikamisvõtme vahetamiseks tuleb anda välja paik, mis asendab tuvastajas
paikade serdi uue serdiga, ning kopeerida uus sert ka keskserverisse uutele
tuvastajatele levitamiseks.

Selleks oleks praktikas kõige otstarbekam tekitada omale uus koopia paikade
tegemise kataloogist (jättes vana kindlasti alles) ning genereerida uues
kataloogis uus võtmepaar. Edasised paigad ehitatakse seal kataloogis ja uue
võtmega. Uus võti aga tuleb levitada vana võtgema signeeritud paigaga, ehk siis
teha uus paik vanas kataloogis, mis asendab faili
/var/www/tuvastaja/data/cacerts/s4apatch.pem uue serdiga. Paiga võib ise kokku
panna või saata uus sert hooldajale, kes sellest paiga vormistab ja
signeerimiseks tagasi saadab.
