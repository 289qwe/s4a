
# /* Copyright (C) 2010, Cybernetica AS, http://www.cybernetica.eu/ */

Paikade tegemine

Ettevalmistused paikade tegemiseks (seda teeb CERT)

Enne esimese paiga välja andmist ja ühegi tuvastaja sertifitseerimist tuleb 
luua võtmepaar paikade signeerimiseks. Seda tuleb teha administraatori arvutis, 
mis on turvaline, ja kindlasti mitte keskuse arvutis.

Paikamise keskkond s4a-patch.tgz tuleb mingis kataloogis lahti pakkida, tekib 
alamkataloog s4a-patch. Seal kataloogis olles tuleb käivitada
./genpatchkey.sh
Võtmele küsitakse ka parooli, seda on edaspidi pakkide signeerimisel vaja.

Selle tulemusena tekivad kaks faili: s4apatch.req on sertifikaadipäring ja
s4apatch.key on salajane võti signeerimiseks. s4apatch.req tuleb toimetada
sertifitseerimiskeskusse ja lasta seal see sertifitseerida (tekib s4apatch.tgz,
kus sees on s4apatch.pem ja cacert.pem).
Samuti peab sertifikaat jõudma tagasi paikade administraatorini.
See tuleb teha enne esimese tuvastaja sertifitseerimist. Nii läheb tuvastajale
koos sertifikaatidega kaasa ka paikade verifitseerimise võti.
Alternatiivina võib paikamise ja sertifitseerimiskeskuse sertifikaadid
lisada otse mõnda tuvastajasse faili
/etc/ssl/pkgca.pem või saata see hooldajale, kes
need ISO imagesse selle nime all kaasa paneks.

Paiga kokku panemine

(seda teeb süsteemi hooldaja ja edastab signeerimata pakettidega paiga CERT-ile)

Tee s4a-patch kataloogi alla uue paiga jaoks uus alamkataloog, nimeks 
soovitavalt paiga number (näiteks 4.6.1) ja kopeeri tarnijalt või tekita ise 
sinna alamkataloogi paiga jaoks vajalikud failid:

spatch.level - paiga versioon, näiteks 4.6.1
spatch.lst - nimekiri bsd-pakettidest, mis paiga sisse panna.
         See nimekiri sisaldab bsd täispakinimesid kujul pakinimi-a.b.c-xy.tgz
packages/ - kataloog, mille alla tuleb panna paiga sisse minevad BSD-pakid
ning mille alt pannakse spatch.lst alusel kokku spatch.tar.

Täida failid. Paki paiga kataloog kokku, nii et sisu jääb alamkataloogina (näiteks
4.6.1.tar.gz sisaldab kataloogi 4.6.1 spatch.* failidega ja packages kataloogiga).
Anna fail CERT-ile pakkide signeerimiseks.

Paiga signeerimine (seda teeb CERT)

Hooldaja saadab tarballi paiga sisuga, näiteks 4.6.1.tar.gz. Paki see lahti
paikamise kataloogi. Sisene tekkivasse alamkataloogi (4.6.1) ja kontrolli sisu üle. 
Signeerimiseks tuleb paiga alamkataloogis packages olevad bsd-paketid installeerida.
selleks kasuta sarnasel kujul käsku:
pkg_add /home/signeerija/s4a-patch/4.6.1/packages/paketinimi.tgz
Et pakett signeerida, tuleb anda s4a-patch kataloogis järgneval kujul käsk:
pkg_create -f /var/db/pkg/paketinimi/+CONTENTS -s x509 -s s4apatch.pem -s s4apatch.key
Vajalik on ka paikade signeerimise võtme parool.
Tulemuseks tekib s4a-patch kataloogi signeeritud pakett sama nimega paketinimi.tgz
Signeeri kõik paigas olevad paketid ning seejärel eemalda need arvutist:
pkg_delete paketinimi
Eelduseks on s4apatch.pem ja cacert.pem sisu /etc/ssl/pkgca.pem failis.

Tõsta signeeritud paketid packages kataloogi, kirjutades signeerimata paketid üle.
Paiga lõplikuks vormistamiseks kasuta paiga alamkataloogis (4.6.1) olles käsku:
../s4apatch.sh
See tekitab signeeritud pakettidega paigafaili kujul patch-4.6.1.tgz. See paigafail tuleb
toimetada keskserverisse /var/www/confserv/patches kataloogi ning uuendada seal
kataloogis current-X.Y faili, nii et faili sisuks oleks paiga versiooni
patchlevel (näiteks 4.6.1 puhul tuleb faili current-4.6 kirjutada sisuks 1).

Paikamisvõtme vahetamine (seda teeb CERT ja hooldaja koos)

Paikamisvõtme jaoks tekitab hooldaja eraldi ports alla sertifikaadivahetuse bsd-paketi.
Paikamisvõtme vahetamiseks tuleb anda välja pakett vana ja uue võtmega, mis asendab tuvastajas
paikade serdi uue serdiga.

Selleks oleks praktikas kõige otstarbekam tekitada omale uus koopia paikade
tegemise kataloogist (jättes vana kindlasti alles) ning genereerida uues
kataloogis uus võti ja päring. Edasised paigad ehitatakse seal kataloogis ja uue
võtmega. Uus võti aga tuleb levitada vana võtmega signeeritud sertifikaadivahetuspaketis,
Paketi paneb kokku hooldaja, selleks saata uus sert hooldajale, kes sellest paki vormistab ja
viimast korda vana võtmega signeerimiseks tagasi saadab.
