#!/bin/sh

# /* Copyright (C) 2010, Cybernetica AS, http://www.cybernetica.eu/ */

if [ -z "$CONFROOT" ]; then
  CONFROOT=/var/www/tuvastaja/configurator
fi
if [ -z "$VARDIR" ]; then
  VARDIR=/var/www/tuvastaja/data/conf
fi

. $CONFROOT/functions.sh

if [ ! -f $VARDIR/$SNMPADDR ]; then
echo "127.0.0.1" > $VARDIR/$SNMPADDR
fi
SNMP=`cat $VAR_SNMP_SERVER`

IP=`cat $VAR_IP_ADDRESS`
if [ -z "$IP" ]; then
  echo No IP address
  exit 1
fi

MGMTIF=`cat $VAR_IFACE`
if [ -z "$MGMTIF" ]; then
  echo No management interface
  exit 1
fi
TRUNKDEVS=`cat $VAR_TRUNKIFACES`

PFCONF=/etc/pf.conf

cat > $PFCONF << END
# automatically generated by gen_pfconf - will be overwritten!

mgmt_if = "$MGMTIF"
me = "$IP"

# skip loopback
set skip on lo

# skip trunk devices for performance
END

for dev in $TRUNKDEVS; do
  echo "set skip on $dev" >> $PFCONF
done

echo >> $PFCONF
echo "# enamble SSH and HTTPS" >> $PFCONF

echo 'pass in quick on $mgmt_if proto tcp from any to $me port ssh' >> $PFCONF
echo 'pass in quick on $mgmt_if proto tcp from any to $me port https' >> $PFCONF

if [ "$SNMP" != "127.0.0.1" ]; then
  echo >> $PFCONF
  echo "# enamble SNMP (TCP+UDP) and NRPE for monitor host" >> $PFCONF
  echo "pass in quick on \$mgmt_if proto udp from $SNMP to \$me port snmp" >> $PFCONF
  echo "pass in quick on \$mgmt_if proto tcp from $SNMP to \$me port smux" >> $PFCONF
  echo "pass in quick on \$mgmt_if proto tcp from $SNMP to \$me port 5666" >> $PFCONF
fi

echo >> $PFCONF
echo 'block return in on $mgmt_if' >> $PFCONF
echo 'pass out all' >> $PFCONF
echo 'block in all' >> $PFCONF

pfctl -f $PFCONF

